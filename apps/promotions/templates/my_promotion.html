<!-- Trong tệp my_promotions.html -->
{% extends 'base.html' %}

{% block title %}My Promotions{% endblock %}

{% block content %}
<h2>My Promotions</h2>

<table class="table">
  <thead>
    <tr>
      <th scope="col">Promotion Title</th>
      <th scope="col">Discount Percentage</th>
      <th scope="col">Start Date</th>
      <th scope="col">End Date</th>
      <th scope="col">Actions</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><input type="text" id="newPromotionTitle"></td>
      <td><input type="number" id="newDiscountPercentage"></td>
      <td><input type="date" id="newStartDate"></td>
      <td><input type="date" id="newEndDate"></td>
      <td><button class="btn btn-success" onclick="saveNewPromotion()" style="width: 70px;">Save</button></td>
    </tr>
    {% if user_promotions %}
      {% for promotion in user_promotions %}
      <tr>
        <td>{{ promotion.title }}</td>
        <td>{{ promotion.discount_percentage }}</td>
        <td>{{ promotion.start_date }}</td>
        <td>{{ promotion.end_date }}</td>
        <td>
          <button class="btn btn-danger" onclick="deletePromotion({{ promotion.id }})" style="width: 70px;">Delete</button>
          <!-- Thêm các thao tác khác nếu cần -->
        </td>
      </tr>
      {% endfor %}
    {% endif %}
  </tbody>
</table>

<div class="modal fade" id="confirmDeletePromotionModal" tabindex="-1" role="dialog"
  aria-labelledby="confirmDeletePromotionModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeletePromotionModalLabel">Confirm Delete</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this promotion?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hiddenConfirmDeletePromotion()">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDeletePromotion()">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
  function saveNewPromotion() {
    const newPromotionTitle = document.getElementById('newPromotionTitle').value;
    const newDiscountPercentage = document.getElementById('newDiscountPercentage').value;
    const newStartDate = document.getElementById('newStartDate').value;
    const newEndDate = document.getElementById('newEndDate').value;

    const requestBody = {
      title: newPromotionTitle,
      discount_percentage: newDiscountPercentage,
      start_date: newStartDate,
      end_date: newEndDate,
    };

    fetch('/promotion/create/', {
      method: 'POST',
      headers: {
        'Content-Type': 'multipart/form-data',
        'Authorization': getAuthorization(),
      },
      body: JSON.stringify(requestBody),
    })
      .then(response => response.json())
      .then(data => {
        console.log('Promotion created:', data);
        {% comment %} window.location.reload(); {% endcomment %}
      })
      .catch(error => console.error('Error creating promotion:', error));
  }

  function hiddenConfirmDeletePromotion() {
    $('#confirmDeletePromotionModal').modal('hide');
    // Reset the global variable
    window.promotionIdToDelete = null;
  }

  function deletePromotion(promotionId) {
    window.promotionIdToDelete = promotionId;
    $('#confirmDeletePromotionModal').modal('show');
  }

  function confirmDeletePromotion() {
    const promotionId = window.promotionIdToDelete;

    if (promotionId) {
      fetch(`/promotion/delete/${promotionId}/`, {
        method: 'DELETE',
        headers: makeHeader(),
      })
        .then(response => {
          if (response.ok) {
            console.log('Promotion deleted:', promotionId);
            window.location.reload();
          } else {
            console.error('Error deleting promotion:', response.statusText);
          }
        })
        .catch(error => console.error('Error deleting promotion:', error))
        .finally(() => {
          $('#confirmDeletePromotionModal').modal('hide');
          window.promotionIdToDelete = null;
        });
    }
  }
</script>
<style>
  /* Add any additional styling if needed */
</style>

{% endblock %}
